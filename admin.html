<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Dashboard | ChinaBridge Academy</title>
    <link rel="stylesheet" href="styles.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Manrope:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      .admin-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 40px 32px;
      }

      .admin-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 32px;
        padding-bottom: 20px;
        border-bottom: 2px solid var(--border);
      }

      .admin-header h1 {
        margin: 0;
        font-size: 2rem;
      }

      .logout-btn {
        background: var(--accent-dark);
        color: white;
        padding: 10px 16px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
      }

      .logout-btn:hover {
        opacity: 0.9;
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 40px;
      }

      .stat-card {
        background: white;
        padding: 20px;
        border-radius: 12px;
        border: 1px solid var(--border);
        text-align: center;
      }

      .stat-card h3 {
        color: var(--text-secondary);
        font-size: 0.9rem;
        margin-bottom: 8px;
        text-transform: uppercase;
      }

      .stat-card .number {
        font-size: 2.5rem;
        font-weight: 700;
        color: var(--accent);
      }

      .users-section h2 {
        margin-bottom: 20px;
        color: var(--text-primary);
      }

      .table-container {
        background: white;
        border-radius: 12px;
        overflow: hidden;
        border: 1px solid var(--border);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
      }

      table {
        width: 100%;
        border-collapse: collapse;
      }

      thead {
        background: var(--surface-muted);
        border-bottom: 2px solid var(--border);
      }

      th {
        padding: 16px;
        text-align: left;
        font-weight: 600;
        color: var(--text-secondary);
        font-size: 0.9rem;
        text-transform: uppercase;
      }

      td {
        padding: 16px;
        border-bottom: 1px solid var(--border);
        vertical-align: middle;
      }

      tbody tr:hover {
        background: var(--surface-muted);
      }

      .email {
        color: var(--accent);
        font-weight: 500;
      }

      .date {
        color: var(--text-secondary);
        font-size: 0.9rem;
      }

      .action-btns {
        display: flex;
        gap: 8px;
      }

      .btn-small {
        padding: 6px 12px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.85rem;
        border: none;
        transition: all 0.3s ease;
      }

      .btn-edit {
        background: var(--accent);
        color: white;
      }

      .btn-edit:hover {
        background: var(--accent-dark);
      }

      .btn-delete {
        background: #fee;
        color: #c33;
        border: 1px solid #fcc;
      }

      .btn-delete:hover {
        background: #fdd;
      }

      .loading {
        text-align: center;
        padding: 40px;
        color: var(--text-secondary);
      }

      .error-message {
        background: #fee;
        color: #c33;
        padding: 16px;
        border-radius: 8px;
        margin-bottom: 20px;
        border-left: 4px solid #c33;
      }

      .no-users {
        text-align: center;
        padding: 40px;
        color: var(--text-secondary);
      }

      @media (max-width: 768px) {
        .admin-container {
          padding: 20px 16px;
        }

        .admin-header {
          flex-direction: column;
          gap: 16px;
          align-items: flex-start;
        }

        .table-container {
          overflow-x: auto;
        }

        table {
          min-width: 100%;
        }

        th, td {
          padding: 12px;
          font-size: 0.85rem;
        }

        .stats-grid {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <header class="site-header">
      <nav class="nav">
        <div class="logo">ChinaBridge Admin</div>
        <div class="nav-links">
          <a href="index.html">Home</a>
          <a href="admin.html" style="color: var(--accent);">Admin Dashboard</a>
        </div>
        <button class="nav-cta" onclick="logout()">Logout</button>
      </nav>
    </header>

    <main>
      <div class="admin-container">
        <div class="admin-header">
          <div>
            <h1>Admin Dashboard</h1>
            <p style="color: var(--text-secondary); margin: 8px 0 0 0;">Manage students and view platform statistics</p>
          </div>
        </div>

        <div class="stats-grid">
          <div class="stat-card">
            <h3>Total Students</h3>
            <div class="number" id="totalStudents">0</div>
          </div>
          <div class="stat-card">
            <h3>New This Month</h3>
            <div class="number" id="newStudents">0</div>
          </div>
          <div class="stat-card">
            <h3>Active Users</h3>
            <div class="number" id="activeUsers">0</div>
          </div>
        </div>

        <div class="users-section">
          <h2>Registered Students</h2>
          <div id="errorMessage" class="error-message" style="display: none;"></div>
          <div id="loadingMessage" class="loading">Loading students...</div>
          <div id="tableContainer" style="display: none;">
            <div class="table-container">
              <table>
                <thead>
                  <tr>
                    <th>ID</th>
                    <th>Name</th>
                    <th>Email</th>
                    <th>Phone</th>
                    <th>Joined</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="studentsList">
                </tbody>
              </table>
            </div>
          </div>
          <div id="noUsers" class="no-users" style="display: none;">
            No students registered yet.
          </div>
        </div>
      </div>
    </main>

    <footer class="site-footer">
      <div>
        <h3>ChinaBridge Academy</h3>
        <p>Admin Dashboard</p>
      </div>
      <p class="copyright">Â© 2025 ChinaBridge Academy. All rights reserved.</p>
    </footer>

    <script>
      const API_BASE_URL = '/api';

      // Load students on page load
      window.addEventListener('load', function() {
        loadStudents();
      });

      async function loadStudents() {
        try {
          const response = await fetch(`${API_BASE_URL}/students`);
          const data = await response.json();

          if (response.ok) {
            displayStudents(data);
            updateStats(data);
          } else {
            showError(data.error || 'Failed to load students');
          }
        } catch (error) {
          showError('Error connecting to server: ' + error.message);
        }
      }

      function displayStudents(students) {
        const studentsList = document.getElementById('studentsList');
        const loadingMessage = document.getElementById('loadingMessage');
        const tableContainer = document.getElementById('tableContainer');
        const noUsers = document.getElementById('noUsers');

        loadingMessage.style.display = 'none';

        if (students.length === 0) {
          noUsers.style.display = 'block';
          return;
        }

        tableContainer.style.display = 'block';
        studentsList.innerHTML = '';

        students.forEach(student => {
          const row = document.createElement('tr');
          const joinDate = new Date(student.created_at).toLocaleDateString('en-US', {
            year: 'numeric',
            month: 'short',
            day: 'numeric'
          });

          row.innerHTML = `
            <td><strong>${student.id}</strong></td>
            <td>${student.first_name || ''} ${student.last_name || ''}</td>
            <td><span class="email">${student.email}</span></td>
            <td>${student.phone || 'N/A'}</td>
            <td><span class="date">${joinDate}</span></td>
            <td>
              <div class="action-btns">
                <button class="btn-small btn-edit" onclick="viewStudent(${student.id})">View</button>
                <button class="btn-small btn-delete" onclick="deleteStudent(${student.id})">Delete</button>
              </div>
            </td>
          `;
          studentsList.appendChild(row);
        });
      }

      function updateStats(students) {
        document.getElementById('totalStudents').textContent = students.length;

        // Count new students this month
        const now = new Date();
        const monthAgo = new Date(now.getFullYear(), now.getMonth(), 1);
        const newThisMonth = students.filter(s => new Date(s.created_at) >= monthAgo).length;
        document.getElementById('newStudents').textContent = newThisMonth;

        // For now, active users = total students (can be updated later)
        document.getElementById('activeUsers').textContent = Math.floor(students.length * 0.8);
      }

      function viewStudent(studentId) {
        alert(`Viewing details for student ${studentId}`);
        // TODO: Implement detailed view modal
      }

      async function deleteStudent(studentId) {
        if (confirm('Are you sure you want to delete this student? This cannot be undone.')) {
          try {
            const response = await fetch(`${API_BASE_URL}/student/${studentId}`, {
              method: 'DELETE'
            });

            if (response.ok) {
              alert('Student deleted successfully');
              loadStudents();
            } else {
              const data = await response.json();
              alert('Error: ' + (data.error || 'Failed to delete student'));
            }
          } catch (error) {
            alert('Error: ' + error.message);
          }
        }
      }

      function showError(message) {
        const errorDiv = document.getElementById('errorMessage');
        const loadingMessage = document.getElementById('loadingMessage');
        loadingMessage.style.display = 'none';
        errorDiv.textContent = message;
        errorDiv.style.display = 'block';
      }

      function logout() {
        localStorage.removeItem('currentUser');
        window.location.href = 'index.html';
      }
    </script>
  </body>
</html>
